<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAN41iYxOHkvh4AgXFDXra3eA-KgGLmIwY",
    authDomain: "myriads-39550.firebaseapp.com",
    projectId: "myriads-39550",
    storageBucket: "myriads-39550.appspot.com",
    messagingSenderId: "26798202385",
    appId: "1:26798202385:web:222f46c8fc57dc95639bb0"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();
  
  console.log("[MYRIADS] - Firestore initialized");

  function myriads_recordBinding(wallet_id, google_analytics_user_id) {
    var current_domain = window.location.origin;
    console.log("[MYRIADS] - Recording binding: ", wallet_id, google_analytics_user_id, current_domain);

    var google_analytics_document_ref = firestore.collection("bindings").doc(google_analytics_user_id);
    var wallet_google_analytics_ids_collection_ref = google_analytics_document_ref.collection("wallets");

    var messageData = {
      id: wallet_id,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      domain: current_domain
    };

    wallet_google_analytics_ids_collection_ref.add(messageData)
      .then(function(docRef) {
        console.log("[MYRIADS] - Binding successfully recorded");
      })
      .catch(function(error) {
        console.error("[MYRIADS] - Failed to record binding:", error);
      });
  }
  
  function myriads_getClientGoogleAnalyticsId() {
    var google_analytics_identifiers = [];
    
    var cookie = {};
    document.cookie.split(';').forEach(function(el) {
      var splitCookie = el.split('=');
      var key = splitCookie[0].trim();
      var value = splitCookie[1];
      
      if (key == "_ga") {
        var google_analytics_client_id = value.substring(6);
        google_analytics_identifiers.push(google_analytics_client_id);
      }
    });
    
    return google_analytics_identifiers;
  }
    
  function myriads_run() {
    var google_analytics_client_identifiers = myriads_getClientGoogleAnalyticsId();
    console.log('[MYRIADS] - Loaded user Google Analytics ID: ', google_analytics_client_identifiers);
    
    if (window.ethereum) {
      console.log('[MYRIADS] - MetaMask detected!');

      window.ethereum.on('accountsChanged', function(accounts) {
        var wallet_address = accounts[0];
        console.log('[MYRIADS] - account changed:', wallet_address);

        if (wallet_address) {
          myriads_recordBinding(wallet_address, google_analytics_client_identifiers[0]);

          gtag('event', 'myriads_wallet_updated');
        }
      });

      window.ethereum.request({ method: 'eth_requestAccounts' })
        .then(function(accounts) {
          var wallet_address = accounts[0];
          console.log('[MYRIADS] - Wallet address:', wallet_address);
        
          myriads_recordBinding(wallet_address, google_analytics_client_identifiers[0]);

          gtag('event', 'myriads_wallet_added');
        })
        .catch(function(error) {
          console.error('[MYRIADS] - Failed to access wallet:', error);
        });
      } 
    else {
      console.error('[MYRIADS] - MetaMask is not available');
    }
  }
    
  console.log('[MYRIADS] - Tracking script loaded. Registering for DOM loaded...');

  document.addEventListener('DOMContentLoaded', function() {
    console.log('[MYRIADS] - Page DOM loaded. Starting tracking...');
    
    myriads_run();
  });
</script>
